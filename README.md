# GitLab Backup & Restore Guide

> ĞŸĞ¾Ğ»Ğ½Ğ¾Ğµ Ñ€ÑƒĞºĞ¾Ğ²Ğ¾Ğ´ÑÑ‚Ğ²Ğ¾ Ğ¿Ğ¾ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ GitLab Ğ¸Ğ· backup Ğ¸ Ñ€ĞµÑˆĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼ Ñ Ğ·Ğ°ÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸ Ñ‚Ğ¾ĞºĞµĞ½Ğ°Ğ¼Ğ¸

[![GitLab Version](https://img.shields.io/badge/GitLab-17.6+-orange)](https://gitlab.com)
[![Kubernetes](https://img.shields.io/badge/Kubernetes-1.28+-blue)](https://kubernetes.io)
[![License](https://img.shields.io/badge/License-MIT-green)](LICENSE)

## ğŸ“‹ Ğ¡Ğ¾Ğ´ĞµÑ€Ğ¶Ğ°Ğ½Ğ¸Ğµ

- [ĞĞ±Ğ·Ğ¾Ñ€ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹](#Ğ¾Ğ±Ğ·Ğ¾Ñ€-Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹)
- [Ğ¡Ğ¸Ğ¼Ğ¿Ñ‚Ğ¾Ğ¼Ñ‹](#ÑĞ¸Ğ¼Ğ¿Ñ‚Ğ¾Ğ¼Ñ‹)
- [ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°](#Ğ¿Ñ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°)
- [Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ: Sign-up Settings (Error 500)](#Ñ€ĞµÑˆĞµĞ½Ğ¸Ğµ-sign-up-settings-error-500)
- [Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ: GitLab Runner](#Ñ€ĞµÑˆĞµĞ½Ğ¸Ğµ-gitlab-runner)
- [ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹ Backup](#Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹-backup)
- [ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾Ğµ Restore](#Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾Ğµ-restore)
- [Ğ”Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ°](#Ğ´Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ°)
- [FAQ](#faq)

---

## ğŸ” ĞĞ±Ğ·Ğ¾Ñ€ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹

ĞŸÑ€Ğ¸ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğ¸ GitLab Ğ¸Ğ· backup Ğ²Ñ‹ Ğ¼Ğ¾Ğ¶ĞµÑ‚Ğµ ÑÑ‚Ğ¾Ğ»ĞºĞ½ÑƒÑ‚ÑŒÑÑ Ñ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ¾Ğ¹ **Ñ€Ğ°ÑÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²ĞºĞ¸ Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ²**. Ğ­Ñ‚Ğ¾ Ğ¿Ñ€Ğ¾Ğ¸ÑÑ…Ğ¾Ğ´Ğ¸Ñ‚, ĞºĞ¾Ğ³Ğ´Ğ°:

1. âœ… Ğ‘Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ° Ğ¸Ğ· backup
2. âŒ Ğ¤Ğ°Ğ¹Ğ» `gitlab-secrets.json` **ĞĞ• Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½** Ğ¸Ğ»Ğ¸ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½ **Ğ´Ñ€ÑƒĞ³Ğ¾Ğ¹**

### Ğ§Ñ‚Ğ¾ Ñ‚Ğ°ĞºĞ¾Ğµ `gitlab-secrets.json`?

Ğ­Ñ‚Ğ¾ Ñ„Ğ°Ğ¹Ğ», ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ°Ñ‰Ğ¸Ğ¹ ĞºĞ»ÑÑ‡Ğ¸ ÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ GitLab, Ğ²ĞºĞ»ÑÑ‡Ğ°Ñ ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ²Ğ°Ğ¶Ğ½Ñ‹Ğ¹ ĞºĞ»ÑÑ‡ **`db_key_base`**, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¹ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ Ğ´Ğ»Ñ ÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ/Ñ€Ğ°ÑÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²ĞºĞ¸ Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ² Ğ² Ğ±Ğ°Ğ·Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ….

**ĞŸÑƒÑ‚ÑŒ Ğº Ñ„Ğ°Ğ¹Ğ»Ñƒ:**
/etc/gitlab/gitlab-secrets.json

### Ğ—Ğ°ÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»Ñ Ğ² `application_settings`:

| ĞŸĞ¾Ğ»Ğµ | ĞĞ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ |
|------|-----------|
| `runners_registration_token` | Ğ¢Ğ¾ĞºĞµĞ½ Ğ´Ğ»Ñ Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸ GitLab Runner |
| `error_tracking_access_token` | Ğ¢Ğ¾ĞºĞµĞ½ Ğ´Ğ»Ñ error tracking |
| `encrypted_ci_jwt_signing_key` | RSA ĞºĞ»ÑÑ‡ Ğ´Ğ»Ñ JWT Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞµĞ¹ CI |
| `encrypted_ci_job_token_signing_key` | RSA ĞºĞ»ÑÑ‡ Ğ´Ğ»Ñ CI job Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ² |

---

## ğŸš¨ Ğ¡Ğ¸Ğ¼Ğ¿Ñ‚Ğ¾Ğ¼Ñ‹

### 1. ĞÑˆĞ¸Ğ±ĞºĞ° 500 Ğ² Sign-up Settings

ĞŸÑ€Ğ¸ Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚ĞºĞµ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹:
https://your-gitlab.com/admin/application_settings/general#js-signup-settings

**ĞÑˆĞ¸Ğ±ĞºĞ° Ğ² Ğ»Ğ¾Ğ³Ğ°Ñ…:**
```log
Started PATCH "/admin/application_settings/general"
Processing by Admin::ApplicationSettingsController#general as HTML
Completed 500 Internal Server Error

OpenSSL::Cipher::CipherError ():
  lib/gitlab/crypto_helper.rb:27:in 'aes256_gcm_decrypt'
  app/models/concerns/token_authenticatable.rb:40
```

2. GitLab Runner Ğ½Ğµ Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€ÑƒĞµÑ‚ÑÑ
ĞŸÑ€Ğ¸ Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚ĞºĞµ Ğ·Ğ°Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ runner:
gitlab-runner register \
  --url https://your-gitlab.com \
  --registration-token <TOKEN>

> ERROR: Registering runner... failed

> runner=xxx status=500 Internal Server Error

ğŸ’¡ ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°

Ğ¢Ğ¾ĞºĞµĞ½Ñ‹ Ğ² Ğ‘Ğ” Ğ·Ğ°ÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ñ‹ ÑÑ‚Ğ°Ñ€Ñ‹Ğ¼ db_key_base, Ğ° GitLab Ğ¿Ñ‹Ñ‚Ğ°ĞµÑ‚ÑÑ Ñ€Ğ°ÑÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¸Ñ… Ğ½Ğ¾Ğ²Ñ‹Ğ¼ ĞºĞ»ÑÑ‡Ğ¾Ğ¼.
```Ğ¡Ñ…ĞµĞ¼Ğ° Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     old db_key_base      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Old GitLab    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚   Encrypted  â”‚
â”‚                 â”‚      (Ğ·Ğ°ÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ»)         â”‚   Token in   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚   Database   â”‚
                                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                      â”‚
                                                      â”‚ Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚ĞºĞ° Ñ€Ğ°ÑÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²ĞºĞ¸
                                                      â”‚
                                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     new db_key_base      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   New GitLab    â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚   âŒ ERROR   â”‚
â”‚                 â”‚   (Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ñ€Ğ°ÑÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ) â”‚  CipherError â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
